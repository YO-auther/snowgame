<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Новогодняя игра</title>
<style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
/* ======================= */
/* ======= CANVAS ======== */
/* ======================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const btnGame1 = { w: 300, h: 150 };
const btnGame2 = { w: 300, h: 150 };

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    btnGame1.x = canvas.width / 2 - 350;
    btnGame1.y = canvas.height / 2 - 75;
    btnGame2.x = canvas.width / 2 + 50;
    btnGame2.y = canvas.height / 2 - 75;
}
window.addEventListener("resize", resize);
resize();

/* ======================= */
/* ======= MUSIC ========= */
/* ======================= */
let musicStarted = false;
let currentMusic = null;

function playMusic(audio) {
    if (!musicStarted) return;
    if (currentMusic !== audio) {
        if (currentMusic) {
            currentMusic.pause();
            currentMusic.currentTime = 0;
        }
        currentMusic = audio;
        currentMusic.play().catch(() => {});
    }
}

function loadAudio(name) {
    const audio = new Audio(name);
    audio.loop = true;
    audio.onerror = () => console.error(`Не удалось загрузить ${name}`);
    return audio;
}

const menuMusic = loadAudio("menu.mp3");
const game1Music = loadAudio("game1.mp3");
const game2Music = loadAudio("game2.mp3");

/* ======================= */
/* ======= IMAGES ======== */
/* ======================= */
const images = {};
const imageNames = [
    "background_menu","background_game1","background_game2",
    "collector","deliver",
    "snow","gold_snow","dead_snow",
    "player_stand","player_go_left","player_go_right","player_go_up","player_go_down",
    "house_red","house_green","house_blue","error_house",
    "present_red","present_green","present_blue",
    "BAM"
];

imageNames.forEach(name => {
    const img = new Image();
    img.src = name + ".png";
    img.onerror = () => console.error(`Не удалось загрузить ${name}.png`);
    images[name] = img;
});

/* ======================= */
/* ======= STATE ========= */
/* ======================= */
let globalState = "menu";
let lastState = null;
let menuMessageTimer = 0;
let menuMessageAlpha = 0;

/* ======================= */
/* ======= INPUT ========= */
/* ======================= */
const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* ======================= */
/* ======= GAME 1 ========= */
/* ======================= */
let snowflakes = [], effects = [];
let score1 = 0, lives1 = 3;
let lastSnowTime = 0;

class Snow {
    constructor(type) {
        this.type = type;
        this.size = 80;
        this.x = Math.random() * (canvas.width - this.size);
        this.y = -100;
        this.speed = 50 + Math.random() * 100;
    }
    update(dt) { this.y += this.speed * dt; }
    draw() { ctx.drawImage(images[this.type], this.x, this.y, this.size, this.size); }
}

class Effect {
    constructor(x, y) { this.x = x; this.y = y; this.life = 0.25; }
    update(dt) { this.life -= dt; }
    draw() { ctx.drawImage(images.BAM, this.x - 25, this.y - 25, 50, 50); }
}

function spawnSnow() {
    const r = Math.random();
    const type = r > 0.9 ? "gold_snow" : r < 0.15 ? "dead_snow" : "snow";
    snowflakes.push(new Snow(type));
}

function initGame1() {
    snowflakes = [];
    effects = [];
    score1 = 0;
    lives1 = 3;
    lastSnowTime = 0;
}

/* ======== HANDLE SNOW CLICK ======== */
function handleSnowClick(mx, my) {
    for (let i = snowflakes.length-1; i >= 0; i--) {
        const s = snowflakes[i];
        const dx = mx - (s.x + s.size/2);
        const dy = my - (s.y + s.size/2);
        if (Math.hypot(dx, dy) < s.size/2) {
            effects.push(new Effect(mx, my));
            if (s.type === "snow") score1++;
            if (s.type === "gold_snow") score1 += 5;
            if (s.type === "dead_snow") lives1--;
            snowflakes.splice(i,1);
        }
    }

    if (lives1 <= 0) {
        if (score1 > highScores.game1) highScores.game1 = score1; // <-- обновление рекорда
        globalState = "menu";
        menuMessageTimer = 120;
        menuMessageAlpha = 1;
        musicStarted = false;
    }
}

/* ======= MOBILE CONTROL ======= */
let touchMove = { x: 0, y: 0, active: false };

canvas.addEventListener("pointerdown", e => {
    musicStarted = true;

    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;

    // ===== МЕНЮ =====
    if (globalState === "menu") {
        if (mx > btnGame1.x && mx < btnGame1.x + btnGame1.w &&
            my > btnGame1.y && my < btnGame1.y + btnGame1.h) {
            initGame1();
            globalState = "game1";
        }

        if (mx > btnGame2.x && mx < btnGame2.x + btnGame2.w &&
            my > btnGame2.y && my < btnGame2.y + btnGame2.h) {
            initGame2();
            globalState = "game2";
        }
        return;
    }

    // ===== GAME 1 =====
    if (globalState === "game1") {
        handleSnowClick(mx, my);
        return;
    }

    // ===== GAME 2 =====
    if (globalState === "game2") {
        touchMove.active = true;
        touchMove.startX = e.clientX;
        touchMove.startY = e.clientY;
    }
});

canvas.addEventListener("pointermove", e => {
    if (!touchMove.active) return;

    const dx = e.clientX - touchMove.startX;
    const dy = e.clientY - touchMove.startY;

    const max = 40;
    touchMove.x = Math.max(-1, Math.min(1, dx / max));
    touchMove.y = Math.max(-1, Math.min(1, dy / max));
});

canvas.addEventListener("pointerup", () => {
    touchMove.active = false;
    touchMove.x = 0;
    touchMove.y = 0;
});
window.addEventListener("pointerup", () => {
    touchMove.active = false;
    touchMove.x = 0;
    touchMove.y = 0;
});

/* ======================= */
/* ======= GAME 2 ========= */
/* ======================= */
let returnedToMenu = false;
let errorHouseTimer = 0;
let errorHouseActive = false;

const PRESENT_SIZE = 80;
const HOUSE_SIZE = 130;
let player = { x:200, y:300, w:90, h:90, speed:300, dir:"stand" };
let presents = [];
let houses = [];
let score2 = 0;
let game2Time = 60;
let combo = 0;
let effects2 = []; 

class Effect2 {
    constructor(x, y) { this.x = x; this.y = y; this.life = 0.33; }
    update(dt) { this.life -= dt; }
    draw() { 
        const progress = 1 - this.life / 0.33;
        const radius = 60 * Math.sin(progress * Math.PI);
        const alpha = Math.max(0, this.life / 0.33);
        const r = 255, g = Math.floor(255 - 155*progress), b = 0;
        ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, radius, 0, Math.PI*2);
        ctx.fill();
    }
}

class ComboEffect {
    constructor(x, y, value) {
        this.x = x;
        this.y = y;
        this.value = value;
        this.life = 1;
    }
    update(dt) { 
        this.life -= dt; 
        this.y -= 60*dt;
    }
    draw() {
        const alpha = Math.max(0, this.life);
        const scale = 1 + (1 - this.life) * 0.5;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.scale(scale, scale);
        ctx.fillStyle = `rgba(255,255,0,${alpha})`;
        ctx.font = "30px Arial";
        ctx.fillText("+" + this.value, -15, 0);
        ctx.restore();
    }
}

function initGame2() {
    score2 = 0;
    combo = 0;
    game2Time = 60;
    player.x = 200; player.y = 300;
    returnedToMenu = false;
    presents = [
        {x:100,y:400,color:"red"},
        {x:400,y:400,color:"green"},
        {x:700,y:400,color:"blue"}
    ];
    houses = [
        {x:100,y:100,color:"red",type:"normal"},
        {x:400,y:100,color:"green",type:"normal"},
        {x:700,y:100,color:"blue",type:"normal"}
    ];

    errorHouseTimer = 8;
    errorHouseActive = false;
}

function updateErrorHouse(dt){
    if(errorHouseActive) return;
    errorHouseTimer -= dt;
    if(errorHouseTimer <= 0){
        houses.push({
            x: Math.random() * (canvas.width - HOUSE_SIZE),
            y: Math.random() * (canvas.height - HOUSE_SIZE),
            type: "error"
        });
        errorHouseActive = true;
    }
}

function checkErrorHouse(){
    if (returnedToMenu) return;
    for (const h of houses) {
        if (h.type !== "error") continue;
        const dx = (player.x + player.w/2) - (h.x + HOUSE_SIZE/2);
        const dy = (player.y + player.h/2) - (h.y + HOUSE_SIZE/2);
        if (Math.hypot(dx, dy) < 80) {
            returnedToMenu = true;
            globalState = "menu";
            if(score2 > highScores.game2) highScores.game2 = score2; // обновление рекорда
            lastState = "game2";
            musicStarted = false;
            menuMessageTimer = 120;
            menuMessageAlpha = 1;
            break;
        }
    }
}

function movePlayer(dt) {
    let dx = 0, dy = 0;

    // клавиатура
    if (keys.a || keys.arrowleft) dx -= 1;
    if (keys.d || keys.arrowright) dx += 1;
    if (keys.w || keys.arrowup) dy -= 1;
    if (keys.s || keys.arrowdown) dy += 1;

    // мобильное управление
    if (touchMove.active) {
        dx = Math.max(-1, Math.min(1, touchMove.x));
        dy = Math.max(-1, Math.min(1, touchMove.y));
    }

    if (dx === 0 && dy === 0) player.dir = "stand";
    else if (Math.abs(dx) > Math.abs(dy)) player.dir = dx > 0 ? "go_right" : "go_left";
    else player.dir = dy > 0 ? "go_down" : "go_up";

    player.x += dx * player.speed * dt;
    player.y += dy * player.speed * dt;

    player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));
    player.y = Math.max(0, Math.min(canvas.height - player.h, player.y));
}

let highScores = { game1: 0, game2: 0 };

/* ===== HANDLE PRESENTS ===== */
function handlePresents(dt) {
    const toRemove = [];
    let anyMatched = false;

    for (let i = 0; i < presents.length; i++) {
        const p = presents[i];

        // Толкание игроком
        if (player.x < p.x + PRESENT_SIZE &&
            player.x + player.w > p.x &&
            player.y < p.y + PRESENT_SIZE &&
            player.y + player.h > p.y
        ) {
            if (player.dir === "go_left")  p.x -= player.speed * dt;
            if (player.dir === "go_right") p.x += player.speed * dt;
            if (player.dir === "go_up")    p.y -= player.speed * dt;
            if (player.dir === "go_down")  p.y += player.speed * dt;

            p.x = Math.max(0, Math.min(canvas.width - PRESENT_SIZE, p.x));
            p.y = Math.max(0, Math.min(canvas.height - PRESENT_SIZE, p.y));
        }

        // Проверка попадания в дома
        for (const h of houses) {
            if (h.type !== "normal") continue;
            if (p.x < h.x + HOUSE_SIZE && p.x + PRESENT_SIZE > h.x &&
                p.y < h.y + HOUSE_SIZE && p.y + PRESENT_SIZE > h.y) {
                if (p.color === h.color) {
                    score2 += 1 + combo;
                    combo++;
                    effects2.push(new Effect2(p.x + PRESENT_SIZE/2, p.y + PRESENT_SIZE/2));
                    effects2.push(new ComboEffect(p.x + PRESENT_SIZE/2, p.y, 1 + combo));
                    toRemove.push(i);
                    anyMatched = true;
                    break;
                }
            }
        }
    }

    // Удаляем подарки
    for (let i = toRemove.length - 1; i >= 0; i--) {
        presents.splice(toRemove[i], 1);
    }

    if (!anyMatched) combo = 0;

    // Новые подарки
    if (presents.length < 10 && Math.random() < dt * 0.6) {
        const colors = ["red", "green", "blue"];
        let x, y;
        do {
            x = Math.random() * (canvas.width - PRESENT_SIZE);
            y = Math.random() * (canvas.height - PRESENT_SIZE);
        } while (x < player.x + player.w && x + PRESENT_SIZE > player.x &&
                 y < player.y + player.h && y + PRESENT_SIZE > player.y);

        presents.push({ x, y, color: colors[Math.floor(Math.random() * colors.length)] });
    }

    // Двигаем дома
    houses.forEach((h, i) => {
        if (h.type === "normal") {
            const t = Date.now() / 1000 + i;
            h.x += Math.sin(t) * 20 * dt;
            h.y += Math.cos(t) * 20 * dt;
            h.x = Math.max(0, Math.min(canvas.width - HOUSE_SIZE, h.x));
            h.y = Math.max(0, Math.min(canvas.height - HOUSE_SIZE, h.y));
        }
    });

    if (score2 > highScores.game2) highScores.game2 = score2;
}

function updateGame2Timer(dt){
    game2Time -= dt;
    if(game2Time <= 0){
        game2Time = 0;
        returnedToMenu = true;
        globalState = "menu";
        if(score2 > highScores.game2) highScores.game2 = score2;
        musicStarted = false;
        menuMessageTimer = 120;
        menuMessageAlpha = 1;
    }
}

/* ===== DRAW EFFECTS ===== */
function drawEffects(arr, dt){
    for(let i=arr.length-1;i>=0;i--){
        arr[i].update(dt);
        arr[i].draw();
        if(arr[i].life<=0) arr.splice(i,1);
    }
}

/* ======================= */
/* ======= MAIN LOOP ===== */
/* ======================= */
let lastTime = 0;

function draw(time){
    const deltaTime = Math.min((time - lastTime)/1000, 0.05);
    lastTime = time;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(globalState==="menu"){
        playMusic(menuMusic);
        ctx.drawImage(images.background_menu,0,0,canvas.width,canvas.height);
        ctx.drawImage(images.collector, btnGame1.x, btnGame1.y, btnGame1.w, btnGame1.h);
        ctx.drawImage(images.deliver, btnGame2.x, btnGame2.y, btnGame2.w, btnGame2.h);

        ctx.fillStyle = "#fff";
        ctx.font = "30px Arial";
        ctx.fillText(`Рекорд Game1: ${highScores.game1}`, 20, canvas.height - 80);
        ctx.fillText(`Рекорд Game2: ${highScores.game2}`, 20, canvas.height - 40);

        if(menuMessageTimer>0){
            ctx.fillStyle = `rgba(255,255,0,${menuMessageAlpha})`;
            ctx.font = "50px Arial";
            ctx.fillText("Возврат в меню!", canvas.width/2-200, canvas.height/2);

            menuMessageTimer--;
            menuMessageAlpha -= 1/120;
            if(menuMessageAlpha<0) menuMessageAlpha=0;
        }
    }

    if(globalState==="game1"){
        playMusic(game1Music);
        ctx.drawImage(images.background_game1,0,0,canvas.width,canvas.height);

        lastSnowTime += deltaTime;
        if(lastSnowTime>0.35){ spawnSnow(); lastSnowTime=0; }

        snowflakes.forEach(s => { s.update(deltaTime); s.draw(); });
        drawEffects(effects, deltaTime);

        ctx.fillStyle = "#fff";
        ctx.font = "30px Arial";
        ctx.fillText(`Score: ${score1}`, 20, 50);
        ctx.fillText(`Lives: ${lives1}`, 20, 90);
        ctx.fillText(`Record: ${highScores.game1}`, 20, 130);
    }

    if(globalState==="game2"){
        playMusic(game2Music);
        ctx.drawImage(images.background_game2,0,0,canvas.width,canvas.height);

        movePlayer(deltaTime);
        updateErrorHouse(deltaTime);
        checkErrorHouse();
        handlePresents(deltaTime);
        updateGame2Timer(deltaTime);

        // Draw player
        ctx.drawImage(images["player_"+player.dir], player.x, player.y, player.w, player.h);

        // Draw houses
        houses.forEach(h => {
            if(h.type==="normal") ctx.drawImage(images[`house_${h.color}`], h.x, h.y, HOUSE_SIZE, HOUSE_SIZE);
            else if(h.type==="error") ctx.drawImage(images.error_house, h.x, h.y, HOUSE_SIZE, HOUSE_SIZE);
        });

        // Draw presents
        presents.forEach(p => ctx.drawImage(images[`present_${p.color}`], p.x, p.y, PRESENT_SIZE, PRESENT_SIZE));

        drawEffects(effects2, deltaTime);

        ctx.fillStyle="#fff";
        ctx.font="30px Arial";
        ctx.fillText(`Score: ${score2}`, 20, 50);
        ctx.fillText(`Time: ${Math.ceil(game2Time)}`, 20, 90);
        ctx.fillText(`Record: ${highScores.game2}`, 20, 130);
    }

    requestAnimationFrame(draw);
}

requestAnimationFrame(draw);
</script>
</body>
</html>
